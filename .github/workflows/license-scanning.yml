name: License Scanning

permissions:
  contents: read

on:
  schedule:
    - cron: '0 8,18 * * 1-5'
  push:
    paths:
      - 'pyproject.toml'
      - 'constraints.txt'
      - '.github/workflows/license-scanning.yml'
  pull_request:
    paths:
      - 'pyproject.toml'
      - 'constraints.txt'
      - '.github/workflows/license-scanning.yml'

env:
  # FINOS-compatible permissive licenses (SPDX identifiers and common variations)
  ALLOW_LICENSES: >-
    MIT License;MIT;MIT-0;MIT No Attribution License (MIT-0);MIT AND Python-2.0;
    Apache Software License;Apache-2.0;Apache 2.0;Apache-2.0 AND BSD-2-Clause;
    BSD License;BSD-2-Clause;BSD-3-Clause;
    Python Software Foundation License;PSF-2.0;
    ISC License (ISCL);ISC;
    Mozilla Public License 2.0 (MPL 2.0);MPL-2.0;
    The Unlicense (Unlicense);Unlicense

  # Packages manually verified as FINOS-compatible but with non-standard license metadata
  # wrapt: BSD-2-Clause (full license text in metadata instead of identifier)
  VERIFIED_PACKAGES: "open-resource-broker wrapt"

jobs:
  scan:
    name: Scan Python dependencies for licenses
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies and pip-licenses
        run: |
          pip install pip-licenses
          pip install -e .
      - name: Show all licenses
        run: |
          echo "=== All detected licenses ==="
          pip-licenses --format=markdown
      - name: Check allowed licenses
        run: |
          ALLOW_LICENSES_CLEAN=$(echo "${{ env.ALLOW_LICENSES }}" | tr -d '\n' | sed 's/  */ /g')
          pip-licenses --allow-only="${ALLOW_LICENSES_CLEAN}" --ignore-packages ${{ env.VERIFIED_PACKAGES }}
